setopt PROMPT_SUBST
c_red=%{`tput setaf 1`%}
c_green=%{`tput setaf 2`%}
c_yello=%{`tput setaf 3`%}
c_blue=%{`tput setaf 4`%}
c_magen=%{`tput setaf 5`%}
c_cyan=%{`tput setaf 6`%}
c_white=%{`tput setaf 7`%}
clr=%{`tput sgr0`%}

parse_git_branch () {
    if git rev-parse --git-dir >/dev/null 2>&1; then
        gitver=$(git branch 2>/dev/null| sed -n '/^\*/s/^\* //p')
        numfil=$(git status | grep "#	" | wc -l)
        echo -e "(±:${gitver}:${numfil})"
    elif hg status -q >/dev/null 2>&1; then
        hgver=$(hg branch 2>/dev/null)
        numfil=$(hg status | wc -l)
        echo -e "(☿:${hgver}:${numfil})"
    else
        return 0
    fi
}

branch_color () {
    color=$c_red
    if git rev-parse --git-dir >/dev/null 2>&1; then
        if git status | grep "nothing to commit" 2>&1 > /dev/null; then
            color=$c_green
        fi
    elif hg status -q >/dev/null 2>&1; then
        if expr $(hg status | wc -l) == 0 2>&1 > /dev/null; then
            color=$c_green
        fi
    else
        return 0
    fi
    echo -ne $color
}

battery() {
    if [[ ! -e /sys/class/power_supply/BAT* ]]; then return 0; fi
    total=10; current=0.; max=0.
    for file in /sys/class/power_supply/BAT*; do
        state=$(cat $file/status)
        ((current += $(cat $file/charge_now)))
        ((max += $(cat $file/charge_full)))
    done
    ((power = current / max))
    ((empty = (1 - power) * total))
    while ((i <= empty)); do
        if [[ $state == 'Charging' ]]; then
            triangles+=◁
        else
            triangles+=▷
        fi
        ((i++))
    done
    while ((i <= total)); do
        if [[ $state == 'Charging' ]]; then
            triangles+=◀
        else
            triangles+=▶
        fi
        ((i++))
    done
    if ((power > .6)); then
        color=$c_green
    elif ((power > .25)); then
        color=$c_yellow
    else
        color=$c_red
    fi
    echo $color$triangles$clr
}

export PROMPT='$c_green%n$clr@$c_cyan%m$clr:$c_white%~$clr$(branch_color)$(parse_git_branch)$clr%# '
export RPROMPT=$(battery)
